import keycode from 'keycode'
import moleculeIcon from '../images/molecule_icon.svg'
import vaultUrl from '../images/cdd30/vault-icon-blue.svg'
import moleculeSelection from '@/shared/components/MoleculeSelection'
import confirm from '@/shared/components/ConfirmDialog.jsx'
import { getMoleculeMrv } from '@/shared/utils/moleculeSearch.js'
import { Terminology } from 'javascripts/cross_app_utilities.js'

CDD.StructureEditor = (function () {
  const MARVIN_JS_IFRAME_ID = 'marvin4js'
  const MARVIN_JS_CANVAS_ID = 'canvas'
  const STRUCTURE_EDITOR_NEW_IMAGE_PATH = moleculeIcon
  const STRUCTURE_EDITOR_SEARCH_IMAGE_PATH = moleculeIcon
  const HIDE_BUTTON_NAMES = new Set([
    'Smart R-group',
    'R-Group attachment',
    'Electron flow double arrow',
    'Increase radical',
    'Rectangle',
    '3D rotate',
    'Clean 3D',
    'About Marvin JS',
    'Pyrrole',
    'CycloPentane',
    'CycloPentane (house)',
    'CycloHexane',
    'Benzene',
  ])
  const TEMPLATE_STRUCTURE_ATTRIBUTES = new Set([
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="0" y2="0.66685"/><atom id="a2" elementType="C" x2="0.7699999999999999" y2="-0.6668499999999999"/><atom id="a3" elementType="C" x2="-0.77" y2="-0.6668499999999999"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a1 a3" order="1"/><bond id="b3" atomRefs2="a2 a3" order="1"/></bondArray></molecule></MChemicalStruct></MDocument></cml>',
      'name': 'Cyclopropane',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABGElEQVRIS+3UvS6EQRTG8d/2GpVE5+sqUAmuQDRChYiLwEWIoCIacQWIClfhq5OoNHpykkNi7b7zvrHb7WmmmDPPf85zzkxLn6PVZ30DQNHhphZdpeJCUTkTmgBG8ZznxvFaB9IEcIj3FB3GZi8BMzjHRIo+YRl3JUjdCq5xgaMU3MAS5nsBWMU6ZtvEbnGM0ypIqYLYDzsCcNMmNJeAsO2zG6QE2MUY1roInOAFkdcxqgBxs4dsbIh0ioBHhVO5/smpAoS3cXiv0MidvET0qjYgpuMAk6Upyf1HbCGm7Vd0q+A+AWc1ASsJmK4DCEsWsV1T/DttH5cIy36iUwVv+SV8NAQMIb6QkRKgoW51eukd/Bs2ABQt/ALu+CgZNbZRiwAAAABJRU5ErkJggg==',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="0" y2="1.0889"/><atom id="a2" elementType="C" x2="1.0889" y2="0"/><atom id="a3" elementType="C" x2="-1.0889" y2="0"/><atom id="a4" elementType="C" x2="0" y2="-1.0889"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a1 a3" order="1"/><bond id="b3" atomRefs2="a2 a4" order="1"/><bond id="b4" atomRefs2="a3 a4" order="1"/></bondArray></molecule></MChemicalStruct></MDocument></cml>',
      'name': 'Cyclobutane',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAA1klEQVRIS82VvQ3CQAyFv8xCmUFoQOwQGgZgDAagITsgaBiEkl2QpTM6TvfjKBglZXR53/nZz+lwfjpnfRYHuIaKd9bKp1RwBA5B+AycLBArQMT3wCaI3oGLBWIBiPgAbIFXAKyAGzC2IC1AfHMVV2cE0qykBqiJmyElQM6WUk+rduUAlpunsKJdKUDmvAfWUUMt0yhnBPIAnsAnJ38HyE1cLVI7XJscQzS9aQZmj6kFMjtoNbt+tipylci75orQD1u7KM6A67pWkOsPx5ror3NTLFom4A1M5DwZLrj3sAAAAABJRU5ErkJggg==',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="N" x2="0" y2="-1.1444398858732308" lonePair="1"/><atom id="a2" elementType="C" x2="1.3205544834023406" y2="-0.3521420527536532"/><atom id="a3" elementType="C" x2="-1.3205544834023406" y2="-0.3521420527536532"/><atom id="a4" elementType="C" x2="1.3205544834023406" y2="1.1444398858732305"/><atom id="a5" elementType="C" x2="-1.3205544834023406" y2="1.1444398858732305"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a3 a1" order="1"/><bond id="b3" atomRefs2="a2 a4" order="2"/><bond id="b4" atomRefs2="a5 a3" order="2"/><bond id="b5" atomRefs2="a4 a5" order="1"/></bondArray></molecule></MChemicalStruct><MElectronContainer occupation="0 0" radical="0" id="o1"><MElectron atomRefs="m1.a1" difLoc="0.0 0.0 0.0"/><MElectron atomRefs="m1.a1" difLoc="0.0 0.0 0.0"/></MElectronContainer></MDocument></cml>',
      'name': 'Pyrrole ',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABsUlEQVRIS+2UP0hbURTGf/feJ/inIiJSCo5dkg6SvggOdRLp0KEtFUG61RYV7SCCLsYOmRTEoRX/UN1KFx07iHQyg4GmGULi1K2IDuKimOH5jjwwECUxN1o7eefvfL/7Hc45ijt+6o79+a+AHmAN+H3LVE+Bd8BW4FOcIAp8B9aBNJCvElQLRIBeoB/4VQqwCBwC88BmlYDnwBjQAgzfA0p1775FFWfKukV/gS/Az4qWlwXdwCjQVm5MBy7m/wWwXaV5Qd4F/LjYh9Wri2aASeAjsAHEgCNLUDMQB94An4EZ4OwqoODVGIjr6h69DYc/xVKpoaXrIK67MpTNTsfz+f1vwBRwXKwve01DoYnOhobHcREckFgqNZgoLnTd5WdKqbjvi3d6+ie2uzu7U+ojFc+16y6/DxKJsKUUOSAJqk8peSVCAP56XcKKgKA4HF54UF+vX4uYNhHxjJHMyclZIpcbudSOGyUoFEWjixER7QHjjqMnk8kPBzYDYJXAxqicxhrQ0bHyxPN8xxjdaozK/PMEkchSu9b6JdDk+2YunR7Ys0lmnSAAADVaq4e+76RtAedxW5cZ9tnrDwAAAABJRU5ErkJggg==',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="0" y2="-1.1444398858732308" lonePair="1"/><atom id="a2" elementType="C" x2="1.3205544834023406" y2="-0.3521420527536532"/><atom id="a3" elementType="C" x2="-1.3205544834023406" y2="-0.3521420527536532"/><atom id="a4" elementType="C" x2="1.3205544834023406" y2="1.1444398858732305"/><atom id="a5" elementType="C" x2="-1.3205544834023406" y2="1.1444398858732305"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a1 a3" order="1"/><bond id="b3" atomRefs2="a2 a4" order="1"/><bond id="b4" atomRefs2="a3 a5" order="1"/><bond id="b5" atomRefs2="a4 a5" order="1"/></bondArray></molecule></MChemicalStruct><MElectronContainer occupation="0 0" radical="0" id="o1"><MElectron atomRefs="m1.a1" difLoc="0.0 0.0 0.0"/><MElectron atomRefs="m1.a1" difLoc="0.0 0.0 0.0"/></MElectronContainer></MDocument></cml>',
      'name': 'Cyclopentane (house)',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAA+0lEQVRIS+2UsQ7BYBSFvw4kJhGLZ7BJiBfgLUgYmcTMxCwmRhLeghcQEptnsIiYJCxy5TaparVNUyJptzbnnq/3tP8xiPgyIvbn64AMcAu5VRI4mx7WDerAHLiGBKSABrAQHyugCEyBUkjAFmgBuxjglmQckec/9ruIysAMyHu+42fBAWgCG/s5qClgBPSAe0CQVMQA6CpgaQfIfU5FVaBvHncfIKkZMV/p3NGpi6w+FR046cDeBVJQXVZ1a7vOq647ajCxxZYAhkBbjcduW3oBnGKTZ45xOEH8AMw5iU3qXC6p47c4wgJkPq0mFx8f/ikJsoFfzxfd/wMeOw47GTAzNYMAAAAASUVORK5CYII=',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="0" y2="1.1849"/><atom id="a2" elementType="C" x2="1.2458999999999998" y2="0.27970000000000006"/><atom id="a3" elementType="C" x2="-1.2459" y2="0.27970000000000006"/><atom id="a4" elementType="C" x2="0.77" y2="-1.1849"/><atom id="a5" elementType="C" x2="-0.77" y2="-1.1849"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a1 a3" order="1"/><bond id="b3" atomRefs2="a2 a4" order="1"/><bond id="b4" atomRefs2="a3 a5" order="1"/><bond id="b5" atomRefs2="a4 a5" order="1"/></bondArray></molecule></MChemicalStruct></MDocument></cml>',
      'name': 'Cyclopentane',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABlElEQVRIS9XUPWtVQRDG8V9AsFILURBELCRgI34BC0EtLNRChRCLqIWQRBtBSGNhIwg2voGFL4UhkFhoCgsVLPwCaiOEgBACASVFkkoIKBPmwPV4T87eQEC3O2dnnv8+s7PTZ5NX3ybr++cA4+l4sNR5qYNteITD+IXPGMZKG6gEcDzFp3E9Be/iVELerQdpA9zEaAq9rAmdTfAD3GqCNAH2Z/Jqis83COzNuC0Ywbd6XDfAQCbdwe22Guf+GG7kYSY6czoBW/EWu/I0HwrFq7CjeIgfOIGfsdEJ2I05HMJMj+JVeD++YB++1wHx/RSfcG+DgGvZypeq/PodnMZVHNsg4D3u43UTIIDLCKsLPUL2ZGm352NcS+/WRS/wEY97BFzBEVxo6qLq/3kM4WSPgDd4jsk2QLRrzJiwvFgI2ZkljZm11p5Nd1D9n0Kc6Fkh4GI6PlfykiMm6hiz5kwh4BViVsX9/bGaZlFYjW66XLfcBRglfYLonr/G93rT9CtmsdTiYgcO4GC3uLZxXVih5rD/H/Abow9AGbkpevYAAAAASUVORK5CYII=',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="-0.33333333333333304" y2="3.269166654346667"/><atom id="a2" elementType="C" x2="-1.6670666559968" y2="2.499166660506667"/><atom id="a3" elementType="C" x2="-1.6670666559968" y2="0.958980006161493"/><atom id="a4" elementType="C" x2="-0.33333333333333304" y2="0.1891666789866664"/><atom id="a5" elementType="C" x2="1.0003999893301336" y2="0.958980006161493"/><atom id="a6" elementType="C" x2="1.0003999893301336" y2="2.499166660506667"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a1 a6" order="1"/><bond id="b3" atomRefs2="a2 a3" order="1"/><bond id="b4" atomRefs2="a3 a4" order="1"/><bond id="b5" atomRefs2="a4 a5" order="1"/><bond id="b6" atomRefs2="a5 a6" order="1"/></bondArray></molecule></MChemicalStruct></MDocument></cml>',
      'name': 'Cyclohexane',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABDklEQVRIS+2VMQ5BQRRFj9ISWAJbsAVRIKGiUpBolSi1EgqVjoJCbMEWWAJLUJIrTyLj+9+fZCommfxM5r9377t5706GwCsTOD9pAeZGqPstsW8BSsAQyAM34AKMgUMSUBJADhgBZfsuLGHHznv7CjByxQEMjPXU2F6dDFm779v9JArBBdC5aqxOFnhMkKFoQAWL25qMjzAXYAY0gDag8tMsybgE1kDvGegCKHnNdprkz383gLZAIisQQAVo+mQHVsDuDxCn3o9IpEGre3ZRYptq0NSirVCDpsHToMk5faxCDqsq5LiRg/aqTBCzc6WX/6uaOLsW67OPXb/GBHtwXGLBnkzPrn1/D7wTfQq8A64eShkjCeW2AAAAAElFTkSuQmCC',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="-3" y2="0.66685"/><atom id="a2" elementType="C" x2="-1.5931399952303946" y2="0.33343"/><atom id="a3" elementType="C" x2="-2.25" y2="-0.33343"/><atom id="a4" elementType="C" x2="-0.7853729649054635" y2="-0.66685"/><atom id="a5" elementType="C" x2="-0.1285129601358581" y2="0.66685"/><atom id="a6" elementType="C" x2="-3.7146270350945363" y2="-0.66685"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a3 a4" order="1"/><bond id="b3" atomRefs2="a2 a5" order="1"/><bond id="b4" atomRefs2="a3 a6" order="1"/><bond id="b5" atomRefs2="a1 a6" order="1"/><bond id="b6" atomRefs2="a5 a4" order="1"/></bondArray></molecule></MChemicalStruct></MDocument></cml>',
      'name': 'Cyclohexane (chair)',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABOUlEQVRIS+3UTSvFURDH8Y9kQbwCNkoJKXYeSspCNkr2FrIXL0EWsmNpoexkIxspSilPa6EQb8BGHheUTs2tv+v+u3XrbuTU6dQ5M/Ob+c50alR51VQ5vn+BsoT/NqIuXJZlUNqgE1fpKQ/RDNawj2OcxPmeI9iKPvRjBO1ownuewC4OcIsBDMY+D6EnvGSC1uIMpxgN3+W8CsaxgJ6ibOsyQnM4wnYEvQvbXuyhGZ95AgnHKjYr4L+BaywVfIsRTWEawxUE78YhWvCRJ5A6Px9lJpu2aNwEhrASSBLv1IPsWsc9FrOX2QpmMYmdCJqm4isTsDEmI92nfRFvqbGP2Ar2r6UE6vGMm5iA5JSyfMhBlRIrjGU6x2KU0wT9WNkKOqJBFeDXgLdSjn/7L6oE1S+ff0RlMVYd0Tf1tTwZar1C4AAAAABJRU5ErkJggg==',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="-0.33342666666591825" y2="3.394259987679253"/><atom id="a2" elementType="C" x2="-1.6669733226642127" y2="2.624259993839254"/><atom id="a3" elementType="C" x2="-1.6669733226642127" y2="1.08407333949408"/><atom id="a4" elementType="C" x2="-0.33342666666591825" y2="0.31407334565408007"/><atom id="a5" elementType="C" x2="1.0003066559975462" y2="1.08407333949408"/><atom id="a6" elementType="C" x2="1.0003066559975462" y2="2.624259993839254"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="2"/><bond id="b2" atomRefs2="a2 a3" order="1"/><bond id="b3" atomRefs2="a3 a4" order="2"/><bond id="b4" atomRefs2="a4 a5" order="1"/><bond id="b5" atomRefs2="a5 a6" order="2"/><bond id="b6" atomRefs2="a6 a1" order="1"/></bondArray></molecule></MChemicalStruct></MDocument></cml>',
      'name': 'Benzene ',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABJklEQVRIS+3Vvy4EURTH8c+WGj2PQCsqr4CCgl4UJFqlP50HoCYIEaJQk0i8gErQ6DSeQEMOZ5LNZHZnd5KpuMlmMjv3/L7nnpzzux0tr07L+oYFHGRCa4MmNihgBlsYxxfesYOHOlAdYAzbmMUFprGCAMb/N/kMYOXqB9jMrI8xiqkUO02lkfy+kafZqyKUAfG+kEJP+MBqCuz2SHIyQRMZd5Vl/NleBuxjCSeYw30GvdXVOst4hDOsF/vLgBBfxC2ecTeAcLHlES+IE5z3A8xjeQjhYusnrvP3D6gs4B8qUQxatGeTNn3FZb82jUGLFg17aDJohynec9Bat4ru9qgyu7DosJFYjcyu3H+t2nU3rLULp3yi1q7MBt73G1J3ZTYWLgK/AS2wXBkEYXY2AAAAAElFTkSuQmCC',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="0" y2="1.6868"/><atom id="a2" elementType="C" x2="1.3875000000000002" y2="1.0186"/><atom id="a3" elementType="C" x2="-1.3875" y2="1.0186"/><atom id="a4" elementType="C" x2="1.7302" y2="-0.4828000000000001"/><atom id="a5" elementType="C" x2="-1.7302" y2="-0.4828000000000001"/><atom id="a6" elementType="C" x2="0.77" y2="-1.6868"/><atom id="a7" elementType="C" x2="-0.77" y2="-1.6868"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a1 a3" order="1"/><bond id="b3" atomRefs2="a2 a4" order="1"/><bond id="b4" atomRefs2="a3 a5" order="1"/><bond id="b5" atomRefs2="a4 a6" order="1"/><bond id="b6" atomRefs2="a5 a7" order="1"/><bond id="b7" atomRefs2="a6 a7" order="1"/></bondArray></molecule></MChemicalStruct></MDocument></cml>',
      'name': 'Cycloheptane',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABnklEQVRIS7XVP4jPcRzH8cfZZGCQQZRBBpkMcodVysnAgoF0XaZziSKZLlF0YdIlMWBhEEpW7pTBJIO6urrLIAODMklvvV1+374f3+/v9+v3ru/y+b2+r+f73/fzGzLgGBqwv24BdzOhk20TawMIzUQ+X9J4HW7hZhPof4CVaXoab9JsNg13Ic5353mAftbB6gBbcDTNn6XB+0Km2xN0ICt6iE//aquA1fiGEF7Gx6YW5O9bcTETW4Pvf9+rAnYgBrmtpXFV9gGxAO9KgBhmZHOqR8DtrDoW4E9UK3iEl7jfI+A49uFICbCAvdVBdQGLBXmFTXWAOJzD+i4M66SfMYJItqNFUdZhHOoT8ASPEe3uAMTHsoRrfQLOYUN+Hx2AH5jC1T4B53EJq6oVjOMKhvsc8ltcwEzdmp7JGcRd00vEXRUzmC6taZwHeQXGuiTcwS9EJ5ajdJu+xlNcbwk5i4PYU9WXAJsRvTyBFw2Q/biHnZhvCwjdKB7gBr4WIGsxiWN4Xqdp+keLNkVfFwuAjTmvaE9tNAFajqAsGzjgN83KRRm/c1CcAAAAAElFTkSuQmCC',
    },
    {
      'structure': '<cml xmlns="http://www.chemaxon.com" version="ChemAxon file format v20.9.0, generated by vunknown" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.chemaxon.com http://www.chemaxon.com/marvin/schema/mrvSchema_20_9_0.xsd"><MDocument><MChemicalStruct><molecule molID="m1"><atomArray><atom id="a1" elementType="C" x2="-0.000050000000000105516" y2="2.0121"/><atom id="a2" elementType="C" x2="1.4227499999999997" y2="1.4228000000000003"/><atom id="a3" elementType="C" x2="-1.4227500000000002" y2="1.4228000000000003"/><atom id="a4" elementType="C" x2="2.01215" y2="2.220446049250313e-16"/><atom id="a5" elementType="C" x2="-2.01215" y2="2.220446049250313e-16"/><atom id="a6" elementType="C" x2="1.4227499999999997" y2="-1.4227999999999998"/><atom id="a7" elementType="C" x2="-1.4227500000000002" y2="-1.4227999999999998"/><atom id="a8" elementType="C" x2="-0.000050000000000105516" y2="-2.0120999999999998"/></atomArray><bondArray><bond id="b1" atomRefs2="a1 a2" order="1"/><bond id="b2" atomRefs2="a1 a3" order="1"/><bond id="b3" atomRefs2="a2 a4" order="1"/><bond id="b4" atomRefs2="a3 a5" order="1"/><bond id="b5" atomRefs2="a4 a6" order="1"/><bond id="b6" atomRefs2="a5 a7" order="1"/><bond id="b7" atomRefs2="a6 a8" order="1"/><bond id="b8" atomRefs2="a7 a8" order="1"/></bondArray></molecule></MChemicalStruct></MDocument></cml>',
      'name': 'Cyclooctane',
      'icon': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABTklEQVRIS73VwSpFURTG8d9VPIB4BJKBoRCeQMojIEMzKU+gZMZMeAQlT4CQmYnEI5AHuAot7aPT6dx7zr069nDvvb7/WmvvtVZLw6vVo/5Qut+ua1cXMI5VbCbhA5zgpQpUBVhOwos4TaKhuZb2L9P+eSdQGWAqebqAt5zwV0FkIEEishFc4RAP+XtlgCOEx2F4U5WCdD6XHImINqoATykFdcUzvYDEu0x0A0TOtzFf0/PitWvs4fdNiik6wwWO+wSsYwkrmX0eMIY7jOKzT0DoxceYxXNo5AG7GMRWn+KZ2T4+sJMHRIW+YxqPfwRM4h7DaGcRNA4IpxtNUQCi39ymqixWbd2sRXW/YibrU//6TcPLxgstII22igA03uzK2nXMgmJ1x/tlc6Gndp3/MY0MnLIvGX0qvM2PzIjqp990W1Ujs2jb2NCvcrTj+TfD8lAZWgtPCQAAAABJRU5ErkJggg==',
    },
  ])

  var sourceStructureElementId
  let disableKeyHandling = false
  // var cxsmartsFormat = 'cxsmarts:u'

  // Marvin 4 JS

  const insertMarvin4JSIFrame = (toolbars, skipInsert) => {
    if ($('#' + MARVIN_JS_IFRAME_ID).length === 0) {
      $('#marvin4js-section').append( // eslint-disable-line jquery-unsafe/no-append
        "<iframe id='" + MARVIN_JS_IFRAME_ID + "' src= '/marvinjs' " +
        "data-toolbars='" + toolbars + "'  " +
        "style='overflow: hidden; width: 100%; height: 100%; border: none;'></iframe>")
      modifyToolbars(skipInsert)
    }
  }

  const modifyToolbars = (skipInsert) => {
    window.getMarvinPromise(MARVIN_JS_IFRAME_ID).done(function (sketcherInstance) {
      // MarvinJS set the display state of the 'Clean 3D' button after this function
      // is executed. Using setTimeout shifts the call to hideButtons after that
      setTimeout(hideButtons, 0)
      sketcherInstance.addButton(
        { name: 'Insert structure', 'image-url': vaultUrl, toolbar: 'N' },
        searchMoleculeAndPaste
      )
      updateInsertVisibility(skipInsert)

      TEMPLATE_STRUCTURE_ATTRIBUTES.forEach(templateStructureAttrs => sketcherInstance.addTemplate(templateStructureAttrs))
    }).fail(function (reason) {
      alert('Error modifying toolbars: ' + reason)
    })
  }

  const hideButtons = () => {
    const iframe = document.getElementById(MARVIN_JS_IFRAME_ID)
    const innerDoc = iframe.contentDocument || iframe.contentWindow.document
    for (const className of ['gwt-ToggleButton', 'gwt-PushButton']) {
      Array.from(innerDoc.getElementsByClassName(className))
        .filter(button => HIDE_BUTTON_NAMES.has(button.title))
        .map(button => button.parentNode)
        .forEach(button => button.style.display = 'none')
    }
  }

  const updateInsertVisibility = (skipInsert) => {
    const iframe = document.getElementById(MARVIN_JS_IFRAME_ID)
    const innerDoc = iframe.contentDocument || iframe.contentWindow.document
    for (let button of innerDoc.getElementsByClassName('gwt-PushButton')) {
      if (button.title == 'Insert structure') {
        button.parentNode.style.display = skipInsert ? 'none' : 'block'
      }
    }
  }

  const searchMoleculeAndPaste = () => {
    disableKeyHandling = true
    moleculeSelection().then(result => {
      getMoleculeMrv(result.identifier).then(mrv => {
        if (mrv == null) {
          confirm({
            title: 'Error',
            content: `${Terminology.t('molecule').titleize()} '${result.value}' is structureless`,
            noCancelOption: true,
          }).then(() => {
          }).catch(() => {
          }).finally(() => disableKeyHandling = false)
        } else if (mrv.includes('x2=')) {
          addStructureAsMrv(mrv, { replace: false })
        } else {
          convertStructure(mrv, 'mrv:-a', mrv2D => addStructureAsMrv(mrv2D, { replace: false }))
        }
        disableKeyHandling = false
      }).catch(() => {
        confirm({
          title: 'Error',
          content: `${Terminology.t('molecule').titleize()} '${result.identifier}' not found`,
          noCancelOption: true,
        }).then(() => {
        }).catch(() => {
        }).finally(() => disableKeyHandling = false)
      })
    }).catch(result => {
      // let the current key event propagate through the system
      setTimeout(() => { disableKeyHandling = false }, 0)
    })
  }

  const closeMarvin4JS = function () {
    $('#useThisStructureButton').off('click')
    $('#launchAppletFromJS').off('click')
    $('#closeStructureEditorLink').off('click')
    $(document).off('keydown.structure_editor')
    CDD.StructureEditor.ready = false
    if (CDD.StructureEditor.sketcherInstance) { CDD.StructureEditor.sketcherInstance.clear() }
    CDD.ModalOverlay.hide()
  }

  // :( Copied from webservices.js
  const getDefaultServices = function () {
    const base = '/webservices2'
    const services = {
      clean2dws: base + '/rest-v0/util/convert/clean',
      molconvertws: base + '/rest-v0/util/calculate/molExport',
      stereoinfows: base + '/rest-v0/util/calculate/cipStereoInfo',
      detailws: base + '/rest-v0/util/detail',
    }
    return services
  }

  var isMolfile = function (structure) {
    return (structure != null && structure.match(/^M\s+END\s*$/m) != null) // No \Z in javascript
  }

  var convertStructure = function (structure, structureFormat, onSuccess,
    onError = (jqXHR, response) => alert('Error loading structure: ' + response.errorMessage)
  ) {
    if (!isMolfile(structure)) { structure = structure.trim() }
    $.ajax(getDefaultServices().molconvertws, {
      contentType: 'application/json; charset=UTF-8',
      dataType: 'json',
      method: 'POST',
      data: JSON.stringify({
        structure: structure,
        parameters: structureFormat,
      }),
      success: function (data) {
        onSuccess(data.structure)
      },
      error: onError,
    })
  }

  const importStructure = (structure) => {
    if (structure === null || _.trim(structure) === '') {
      addStructureAsMrv(null)
    } else {
      convertStructure(structure, 'mrv:-a', addStructureAsMrv)
    }
  }

  const addStructureAsMrv = (mrv, options = {}) => {
    options = { replace: true, ...options }
    window.getMarvinPromise(MARVIN_JS_IFRAME_ID).done(sketcherInstance => {
      sketcherInstance.setServices(getDefaultServices())
      CDD.StructureEditor.sketcherInstance = sketcherInstance
      CDD.StructureEditor.ready = true
      if (options.replace) {
        sketcherInstance.importStructure('mrv', mrv)
      } else {
        sketcherInstance.pasteStructure('mrv', mrv)
      }
      window.frames[MARVIN_JS_IFRAME_ID].contentDocument.getElementById(MARVIN_JS_CANVAS_ID).focus()
    }).fail(reason => {
      alert('Error loading structure editor: ' + reason)
    })
  }

  var structureImagePlaceholder = function (editorContext) {
    if (editorContext === 'search') {
      return STRUCTURE_EDITOR_SEARCH_IMAGE_PATH
    } else {
      return STRUCTURE_EDITOR_NEW_IMAGE_PATH
    }
  }

  var updatePageStructureElements = function (structure, structureImageUrl) {
    $('#' + sourceStructureElementId).val(structure)
    $('#structure_query').attr('src', structureImageUrl)
  }

  var attachToUseThisStructureButton = function (editorContext, structureFormat, noStructureCallback, withStructureCallback) {
    window.getMarvinPackage(MARVIN_JS_IFRAME_ID).done(function (marvin4JS) {
      const submitFunction = function () {
        if (marvin4JS.sketcherInstance) {
          if (marvin4JS.sketcherInstance.isEmpty()) {
            noStructureCallback()
          } else {
            marvin4JS.sketcherInstance.exportStructure('mrv')
              .then(mrv => {
                convertStructure(mrv, structureFormat, function (molfile) {
                  var image = CDD.moleculeImageHelper.moleculeImagePath(molfile, editorContext)
                  withStructureCallback(molfile, image)
                })
              })
          }
        }
        return false
      }

      const handleKeys = (event) => {
        if (CDD.StructureEditor.ready) {
          if (disableKeyHandling) return
          switch (keycode(event)) {
            case 'enter': {
              submitFunction()
              closeMarvin4JS()
              break
            }
            case 'esc': {
              closeMarvin4JS()
              break
            }
          }
        }
      }

      $('#useThisStructureButton').on('click', submitFunction)
      $(document).on('keydown.structure_editor', handleKeys)
    })
  }

  var setupUseThisStructureButton = function (editorContext, structureFormat) {
    var noStructureCallback = function () {
      updatePageStructureElements('', structureImagePlaceholder(editorContext))
      $('#structure_query').attr('hidden', true)
      $('#no_structure_query').attr('hidden', false)
      closeMarvin4JS()
    }

    var withStructureCallback = function (molfile, image) {
      updatePageStructureElements(molfile, image)
      $('#structure_query').attr('hidden', false)
      $('#no_structure_query').attr('hidden', true)
      closeMarvin4JS()
    }

    return attachToUseThisStructureButton(
      editorContext,
      structureFormat,
      noStructureCallback,
      withStructureCallback
    )
  }

  var setupUseThisStructureButtonForPromise = function (editorContext, structureFormat, resolve, reject) {
    var withStructureCallback = function (structure, image) {
      resolve({ image: image, mrv: structure })
    }

    return attachToUseThisStructureButton(
      editorContext,
      structureFormat,
      reject,
      withStructureCallback
    )
  }

  var setupMarvin4JS = function (structure, cancelCallback, toolbars, skipInsert) {
    CDD.ModalOverlay.show()
    insertMarvin4JSIFrame(toolbars, skipInsert)
    updateInsertVisibility(skipInsert)
    importStructure(structure)
    $('#closeStructureEditorLink').on('click', cancelCallback)
  }

  var setDefaultOptions = function (options = {}) {
    const { structureFormat = 'mol', toolbars = 'reporting', skipInsert = false } = options
    return { structureFormat, toolbars, skipInsert }
  }

  var openMarvin4JS = function (structureElementId, editorContext, options = {}) {
    options = setDefaultOptions(options)

    sourceStructureElementId = structureElementId
    var structure = $('#' + sourceStructureElementId).val()

    setupMarvin4JS(structure, closeMarvin4JS, options.toolbars, options.skipInsert)
    setupUseThisStructureButton(editorContext, options.structureFormat)

    return false
  }

  var openMarvin4JSWithPromise = function (structure, editorContext, options = {}) {
    options = setDefaultOptions(options)

    return new Promise(function (resolve, reject) {
      var cancel = function () { reject(new Error('cancelled')) }
      var empty = function () { reject(new Error('empty')) }

      setupMarvin4JS(structure, cancel, options.toolbars, options.skipInsert)
      setupUseThisStructureButtonForPromise(editorContext, options.structureFormat, resolve, empty)
    }).finally(closeMarvin4JS)
  }

  return {
    openMarvin4JS: openMarvin4JS,
    openMarvin4JSWithPromise: openMarvin4JSWithPromise,
    convertStructure: convertStructure,
    marvin4JSServices: getDefaultServices,
  }
})()
